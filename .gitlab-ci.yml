stages:
  - lint
  - build
  - test
  - release

variables:
  CONTAINER_TEST_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest

checkbadchars:
  stage: lint
  script: >
    test $(grep -caxv '.*' *.f *.f90 *.h *.h77 README* LICENSE* cqlinput* CQL3D_users.txt eqdsk |
    cut -d: -f2 | awk '{ SUM += $1} END { print SUM }') -eq 0

enforce_unixish:
  stage: lint
  script: test $(file -k  *.f *.f90 *.h *.h77 README* LICENSE* cqlinput* CQL3D_users.txt eqdsk | grep -c "CRLF") -eq 0

build:centos7:
  stage: build
  image: $CONTAINER_TEST_IMAGE
  script:
  - make -f  makefile_gfortran64.CentOS7
  artifacts:
    paths:
    - xcql3d_gfortran64
    expire_in: 1 week

case1:
  stage: test
  image: $CONTAINER_TEST_IMAGE
  script:
  - cd ci/case1
  - ../../xcql3d_gfortran64
  - nccmp -dmgfs reference.nc mst_stand_lh00001.MergedCQL3D_direct_lh-dis.nc
  artifacts:
    when: always
    paths:
    - ci/case1/mst_stand_lh00001.MergedCQL3D_direct_lh-dis.nc
    - ci/case1/mst_stand_lh00001.MergedCQL3D_direct_lh-dis.ps
    expire_in: 1 week

  dependencies:
  - build:centos7

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

docker build:
  stage: build
  image: docker:stable
  services:
  - docker:dind
  script:
  - docker pull $CONTAINER_RELEASE_IMAGE || true
  - docker build -f Dockerfile.centos7  --cache-from $CONTAINER_RELEASE_IMAGE -t $CONTAINER_TEST_IMAGE .
  - docker push $CONTAINER_TEST_IMAGE
  only:
    changes:
      - ci/Dockerfile.centos7


release-image:
  stage: release
  image: docker:stable
  services:
  - docker:dind
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE
  only:
    - master
  only:
    changes:
      - ci/Dockerfile.centos7
